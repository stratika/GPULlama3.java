#!/bin/bash
source set_paths

# Default values 
MODEL_PATH=""
PROMPT=""
SYSTEM_PROMPT=""
TEMPERATURE=0.1
TOP_P=0.95
SEED=$(date +%s)
MAX_TOKENS=512
STREAM=true
ECHO=false
INSTRUCT=true
INTERACTIVE=false
USE_GPU=false
DEBUG_GPU=true

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -m|--model) MODEL_PATH="$2"; shift 2 ;;
        -p|--prompt) PROMPT="$2"; shift 2 ;;
        -sp|--system-prompt) SYSTEM_PROMPT="$2"; shift 2 ;;
        --temperature) TEMPERATURE="$2"; shift 2 ;;
        --top-p) TOP_P="$2"; shift 2 ;;
        --seed) SEED="$2"; shift 2 ;;
        -n|--max-tokens) MAX_TOKENS="$2"; shift 2 ;;
        --stream) STREAM="$2"; shift 2 ;;
        --echo) ECHO="$2"; shift 2 ;;
        -i|--interactive|--chat) INTERACTIVE=true; INSTRUCT=false; shift ;;
        --instruct) INSTRUCT=true; INTERACTIVE=false; shift ;;
        --gpu) USE_GPU=true; shift ;;
        --debug) DEBUG_GPU=true; shift ;;
        --help|-h) print_usage; exit 0 ;;
        *) echo "Unknown option: $1"; print_usage; exit 1 ;;
    esac
done

# Validate model path
if [ -z "$MODEL_PATH" ]; then
    echo "Error: -m/--model <path> is required"
    exit 1
fi

CMD=()
CMD+=("$JAVA_HOME/bin/java")
CMD+=("-server")
CMD+=("-XX:-UseCompressedOops")
CMD+=("-XX:+UnlockExperimentalVMOptions")
CMD+=("-XX:+EnableJVMCI")
CMD+=("-XX:-UseCompressedClassPointers")
CMD+=("-Xms12g")
CMD+=("-Xmx12g")
CMD+=("--enable-preview")
CMD+=("-Djava.library.path=$TORNADO_SDK/lib")
CMD+=("--module-path" ".:$TORNADO_SDK/share/java/tornado")
CMD+=("-Dtornado.load.api.implementation=uk.ac.manchester.tornado.runtime.tasks.TornadoTaskGraph")
CMD+=("-Dtornado.load.runtime.implementation=uk.ac.manchester.tornado.runtime.TornadoCoreRuntime")
CMD+=("-Dtornado.load.tornado.implementation=uk.ac.manchester.tornado.runtime.common.Tornado")
CMD+=("-Dtornado.load.annotation.implementation=uk.ac.manchester.tornado.annotation.ASMClassVisitor")
CMD+=("-Dtornado.load.annotation.parallel=uk.ac.manchester.tornado.api.annotations.Parallel")
[ "$USE_GPU" = true ] && CMD+=("-Duse.tornadovm=true")
[ "$DEBUG_GPU" = true ] && CMD+=("-Dtonado.debug=true") && CMD+=("-Dtonado.threadInfo=true")
CMD+=("-Dtornado.threadInfo=false")
CMD+=("-Dtornado.debug=true")
CMD+=("-Dtornado.fullDebug=false")
CMD+=("-Dtornado.print.kernel=false")
CMD+=("-Dtornado.print.bytecodes=false")
CMD+=("-Dtornado.device.memory=7GB")
CMD+=("-Dtornado.profiler=false")
CMD+=("-Dtornado.deallocate.buffers=false")
#CMD+=("-Dgraal.Dump=*:5")
#CMD+=("-Dgraal.PrintGraph=Network")
#CMD+=("-Dgraal.PrintBackendCFG=true")
CMD+=("--upgrade-module-path" "$TORNADO_SDK/share/java/graalJars")
CMD+=("-XX:+UseParallelGC")
CMD+=("@$TORNADO_SDK/etc/exportLists/common-exports")
CMD+=("@$TORNADO_SDK/etc/exportLists/ptx-exports")
CMD+=("--add-modules" "ALL-SYSTEM,tornado.runtime,tornado.annotation,tornado.drivers.common,tornado.drivers.ptx")
CMD+=("-cp" "$LLAMA_ROOT/target/gpu-llama3-1.0-SNAPSHOT.jar")
CMD+=("com.example.LlamaApp")
CMD+=("-m" "$MODEL_PATH")
[ ! -z "$PROMPT" ] && CMD+=("-p" "$PROMPT")
[ ! -z "$SYSTEM_PROMPT" ] && CMD+=("-sp" "$SYSTEM_PROMPT")
CMD+=("--temperature" "$TEMPERATURE")
CMD+=("--top-p" "$TOP_P")
CMD+=("--seed" "$SEED")
CMD+=("--max-tokens" "$MAX_TOKENS")
CMD+=("--stream" "$STREAM")
CMD+=("--echo" "$ECHO")
[ "$INTERACTIVE" = true ] && CMD+=("--interactive")
[ "$INSTRUCT" = true ] && CMD+=("--instruct")

# Execute command
"${CMD[@]}"
